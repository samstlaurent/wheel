<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Sporcle of the Day Selector</title>
	<link rel="icon" href="images/wheel.ico" type="image/ico">
	<link rel="stylesheet" href="style.css">
</head>
<body>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
		import { getFirestore, collection, doc, setDoc, serverTimestamp, query, orderBy, limit, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
		import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
		import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

		const firebaseConfig = {
			apiKey: "AIzaSyATilkEHEFHVUzED0ErnUcM4DoqFMxlWnQ",
			authDomain: "wheel-d9e0e.firebaseapp.com",
			projectId: "wheel-d9e0e",
			storageBucket: "wheel-d9e0e.firebasestorage.app",
			messagingSenderId: "66259585614",
			appId: "1:66259585614:web:5f86cb61233129f3a0511f",
			measurementId: "G-N7348SL49Z"
		};

		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		const auth = getAuth(app);
		const analytics = getAnalytics(app);
		
		let localUserId = localStorage.getItem("localUserId");
		let isFirstVisit = false;

		if (!localUserId) {
			localUserId = crypto.randomUUID();
			localStorage.setItem("localUserId", localUserId);
			isFirstVisit = true;
		}
		window.isFirstVisit = isFirstVisit;
		
		signInAnonymously(auth).catch(err => console.error("Auth error:", err));
		
		let currentUserId = null;
		onAuthStateChanged(auth, (user) => {
			if (user) currentUserId = user.uid;
		});
		
		window.firebaseAddSpin = async function (spinResult) {
			try {
				const now = new Date();
				const docId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

				await setDoc(doc(db, "wheelSpins", docId), {
					winner: spinResult,
					userId: localUserId || "unknown",
					userName: window.userName || "unknown",
					timestamp: serverTimestamp()
				});
			} catch (err) {
				console.error("Firebase log error:", err);
			}
		};
		
		let statsChart = null; // Keep a reference so we can update the chart
		window.currentChartType = 'bar'; // Track current chart type

		window.logWinnerFrequencyFromFirestore = async function (limitCount = 1000) {
			try {
				const spinsRef = collection(db, "wheelSpins");
				const q = query(
					spinsRef,
					orderBy("timestamp", "desc"),
					limit(limitCount)
				);

				const snapshot = await getDocs(q);

				// Initialize all names with zero in original order
				const counts = {};
				names.forEach(name => counts[name] = 0);

				// Count actual wins
				snapshot.forEach(doc => {
					const winner = doc.data().winner;
					if (!winner) return;
					if (!(winner in counts)) counts[winner] = 0;
					counts[winner]++;
				});

				// Prepare labels and data in wheel/button order
				const labels = [...names];              // original wheel order
				const data = labels.map(name => counts[name] || 0);

				// Get colors matching the wheel colors - use nameColorMap if available
				const colors = labels.map((name) => {
					// Try to get color from the nameColorMap that was set when wheel was drawn
					if (window.nameColorMap && window.nameColorMap[name]) {
						return window.nameColorMap[name];
					}
					
					// Fallback to calculating color based on position in original array
					const i = labels.indexOf(name);
					const colorMode = window.colorMode || localStorage.getItem("colorMode") || "hue";
					const baseHue = window.baseHue || Number(localStorage.getItem("baseHue")) || 200;
					
					if (colorMode === "hue") {
						const hue = Math.round((360 * i / labels.length) % 360);
						return `hsl(${hue}, 80%, 60%)`;
					} else if (colorMode === "lightness") {
						const light = 25 + 75 * (i / labels.length);
						return `hsl(${baseHue}, 80%, ${light}%)`;
					}
				});

				// Render / update chart
				const ctx = document.getElementById("statsChart").getContext("2d");

				if (statsChart) {
					statsChart.destroy(); // Destroy existing chart before creating new one
				}
				
				const chartConfig = {
					type: window.currentChartType,
					data: {
						labels: labels,
						datasets: [{
							label: 'Wins',
							data: data,
							backgroundColor: colors
						}]
					},
					options: {
						responsive: true,
						animation: false,
						plugins: {
							legend: { 
								display: window.currentChartType === 'pie',
								position: 'right'
							},
							tooltip: { 
								mode: window.currentChartType === 'pie' ? 'nearest' : 'index',
								intersect: window.currentChartType === 'pie'
							}
						}
					}
				};

				// Add specific options for bar chart
				if (window.currentChartType === 'bar') {
					chartConfig.options.scales = {
						y: {
							beginAtZero: true,
							ticks: { stepSize: 1 }
						}
					};
				}

				statsChart = new Chart(ctx, chartConfig);

			} catch (err) {
				console.error("Failed to fetch winner stats:", err);
			}
		};
		
		function formatDateTime(date) {
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');

			let hours = date.getHours();
			const minutes = String(date.getMinutes()).padStart(2, '0');
			const ampm = hours >= 12 ? 'PM' : 'AM';
			
			hours = hours % 12;
			if (hours === 0) hours = 12; // convert 0 to 12 for 12-hour format

			return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
		}
		
		function subscribeToRecentSpins() {
			const spinsRef = collection(db, "wheelSpins");

			const q = query(
				spinsRef,
				orderBy("timestamp", "desc"),
				limit(100)
			);

			onSnapshot(q, snapshot => {
				const tbody = document.getElementById("recentSpinsBody");
				tbody.innerHTML = ""; // clear first

				// Add fake header row
				const headerRow = document.createElement("tr");
				headerRow.classList.add("fake-header");
				headerRow.innerHTML = `
					<td>Name</td>
					<td>Time</td>
				`;
				tbody.appendChild(headerRow);

				// Add data rows
				snapshot.forEach(doc => {
					const data = doc.data();
					const name = data.winner || "Unknown";
					const ts = data.timestamp?.toDate ? data.timestamp.toDate() : null;

					const timeStr = ts ? formatDateTime(ts) : "--";

					const row = document.createElement("tr");
					row.innerHTML = `
						<td>${name}</td>
						<td>${timeStr}</td>
					`;
					tbody.appendChild(row);
				});
			});
		}

		subscribeToRecentSpins();
	</script>

	<div id="recentSpinsContainer">
		<h3>Recent Spins</h3>
		<table id="recentSpinsTable">
			<tbody id="recentSpinsBody"></tbody>
		</table>
		<div id="recentSpinsFooter">
			<button id="statsButton">Show Graph</button>
		</div>
	</div>

	<canvas id="mainCanvas" width="800" height="600"></canvas>
	
	<div id="buttonColumn">
		<button id="instructionsButton">Instructions</button>
		<button id="optionsButton">Options</button>
		<button id="downloadButton" disabled>Download Video</button>
		<button id="screenshotButton" disabled>Download Screenshot</button>
	</div>

	<div id="nameList"></div>
	
	<div id="instructionsModal">
		<div id="instructionsContent">
			<h2>Instructions</h2>
			<p>
				<span class="instructionLine">
					Click the <img src="images/selectorIconDisabled.png" class="instructionsInlineIcon"> icon above your <span class="instructionsInlineNameButton">Name</span> to mark yourself as the current selector.
				</span>
				<span class="instructionLine">
					Click on the <span class="instructionsInlineNameButton">Name</span> buttons to temporarily remove those who are unavailable.
				</span>
				<span class="instructionLine">
					Spin the wheel then use <span class="instructionsInlineDownloadButton">Download Video</span> to post in the Teams chat.
				</span>
			</p>
		</div>
	</div>
	
	<div id="optionsModal">
		<div id="optionsContent">
			<h3>Options</h3>
			<label class="optionRow">
				<input type="radio" name="colorMode" value="hue" />
				Full Color Wheel
			</label>
			<label class="optionRow optionRow--withSlider">
				<input type="radio" name="colorMode" value="lightness" />
				<span>Fixed Hue</span>
				<input
					type="range"
					id="hueSlider"
					min="0"
					max="360"
					value="200"
					style="display:none;"
				/>
			</label>
		</div>
	</div>
	
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<div id="statsModal">
		<div id="statsContent">
			<h3>Winner Frequency</h3>
			<div id="chartTypeToggle" style="margin-bottom: 10px;">
				<button id="barChartBtn" class="chartTypeBtn active" style="background: #4ba3f2; margin: 2px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; color: white;">Bar Chart</button>
				<button id="pieChartBtn" class="chartTypeBtn" style="background: #999; margin: 2px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; color: white;">Pie Chart</button>
			</div>
			<canvas id="statsChart" width="350" height="250"></canvas>
		</div>
	</div>
	
	<audio id="wheelTick" src="https://raw.githubusercontent.com/samstlaurent/wheel/main/audio/wheelTick.mp3" crossorigin=""></audio>
	<audio id="wheelStopNeutral" src="https://raw.githubusercontent.com/samstlaurent/wheel/main/audio/wheelStopNeutral.mp3" crossorigin=""></audio>
	<audio id="wheelStopParty" src="https://raw.githubusercontent.com/samstlaurent/wheel/main/audio/wheelStopParty.mp3" crossorigin=""></audio>
	<audio id="wheelStopSpectacle" src="https://raw.githubusercontent.com/samstlaurent/wheel/main/audio/wheelStopSpectacle.mp3" crossorigin=""></audio>
	<audio id="buttonPress" src="https://raw.githubusercontent.com/samstlaurent/wheel/main/audio/buttonPress.mp3" crossorigin=""></audio>

	<script src="script.js"></script>
</body>
</html>